# CacheSystem

这是一个基于[KamaCache](https://github.com/youngyangyang04/KamaCache)的学习项目，在复现的基础上添加了自适应算法。

## 项目简介

本项目是一个高性能缓存系统的实现，旨在学习和理解缓存机制的工作原理。在参考KamaCache项目的基础上，实现了核心的缓存功能，并创新性地添加了自适应算法来动态选择最适应的缓存策略，确保在不同场景下都能保持最高的命中率。

## 与KamaCache的对比与创新

### 基础功能复现

- 完整复现了KamaCache的三种核心缓存策略：LRU、LFU和ARC
- 保留了KamaCache的优化特性，如LRU分片、LFU分片和最大平均访问频次
- 采用相似的架构设计，使用模板化实现支持任意键值类型

### 主要创新点

#### 1. 自适应缓存算法（核心创新）

- **多策略并行运行**：同时维护LRU、LFU、LFU-Aging和ARC四种缓存策略
- **性能监控**：实时统计各策略的命中率
- **动态切换**：根据性能数据自动选择最优策略
- **平滑过渡**：使用可配置的切换阈值，避免频繁切换

#### 2. 改进的LFU-Aging策略

- **更精细的频率衰减机制**：
  - 引入可配置的衰减因子(agingFactor)，替代固定的减半操作
  - 基于操作次数和平均频率双重触发条件
  - 更平滑的频率衰减曲线，避免过度调整
- **动态参数调整**：
  - 可配置的衰减阈值(agingThreshold)
  - 可配置的衰减因子(agingFactor)
  - 支持不同场景下的参数优化

#### 3. 更频繁的性能评估

- KamaCache：基于时间间隔的评估
- CacheSystem：基于操作次数的评估（每1000次操作评估一次）
- 更快的响应速度，适应快速变化的访问模式

#### 4. 更敏感的策略切换

- 可配置的切换阈值（默认2%）
- 避免频繁切换导致的性能抖动
- 保持统计连续性，不重置性能数据

#### 5. 增强的测试用例

- 工作负载变化测试：模拟不同阶段的访问模式
- 策略切换可视化：实时显示当前使用的策略
- 多场景测试：热点访问、扩展访问、大范围访问等

### 性能优化

- 更智能的内存管理，减少内存碎片
- 优化的数据结构，提高访问效率
- 细粒度的锁控制，减少线程竞争

## 特性

- 基于KamaCache的核心功能实现，使用C++17标准
- 实现了多种经典缓存替换策略：
  - LRU (Least Recently Used)
  - LFU (Least Frequently Used)
  - LFU with Aging（改进版）
  - ARC (Adaptive Replacement Cache)
- **自适应算法**：根据访问模式动态选择最优缓存策略
- 线程安全的实现，支持多线程环境
- 模板化设计，支持任意键值类型

## 项目结构

```
CacheSystem/
├── XAdaptiveCache.h         # 自适应缓存实现（核心创新）
├── XCachePolicy.h           # 缓存策略基类接口
├── XLRUCache.h              # LRU缓存实现
├── XLFUCache.h              # LFU缓存实现（含改进的LFU-Aging）
├── XArcCache/               # ARC缓存实现
│   ├── XArcCache.h          # ARC缓存主类
│   ├── XArcLRUpart.h        # ARC的LRU部分
│   ├── XArcLFUpart.h        # ARC的LFU部分
│   └── XArcCacheNode.h      # ARC缓存节点
├── testAdaptive.cpp         # 自适应缓存测试
├── testAllCachePolicy.cpp   # 所有缓存策略测试
├── CMakeLists.txt           # CMake构建文件
└── README.md                # 项目说明文档
```

## 快速开始

### 编译项目

```bash
# 在项目根目录下执行
mkdir build && cd build
cmake ..
make
```

### 运行测试

```bash
# 运行自适应缓存测试
./testAdaptive

# 运行所有缓存策略测试P
./testAllCachePolicy
```

### 测试结果

Adaptive在不同场景下都能选择到最适应的缓存策略：

![测试结果](./image/test.jpg)

## 自适应算法详解

本项目的核心创新是实现了自适应缓存算法，该算法具有以下特点：

1. **多策略并行运行**：同时维护LRU、LFU、LFU-Aging和ARC四种缓存策略
2. **性能监控**：实时统计各策略的命中率
3. **动态切换**：根据性能数据自动选择最优策略
4. **平滑过渡**：使用可配置的切换阈值，避免频繁切换

### 算法工作原理

- 每次缓存操作都会在所有策略上执行，但只返回当前策略的结果
- 定期评估各策略的性能（每1000次访问评估一次）
- 当某个策略的命中率显著高于当前策略（超过2%）时，自动切换
- 使用互斥锁保证线程安全

### LFU-Aging策略详解

LFU-Aging是对传统LFU策略的改进，解决了过去的热点数据最近一直没被访问，却仍占用缓存等问题：

1. **频率衰减机制**：
   - 基于操作次数和平均频率的双重触发条件
   - 使用可配置的衰减因子进行平滑衰减
   - 避免频率突然变化导致的性能抖动

2. **动态参数调整**：
   - 衰减阈值(agingThreshold)：控制触发衰减的操作次数
   - 衰减因子(agingFactor)：控制频率衰减的程度
   - 最大平均频率(maxAverageFreq)：控制缓存中数据的整体频率水平

3. **性能优化**：
   - 更精细的频率统计
   - 更智能的缓存淘汰策略
   - 更好的适应性，应对不同访问模式

## 技术亮点

- **模板化设计**：支持任意键值类型的缓存
- **线程安全**：使用std::mutex保证多线程环境下的安全访问
- **内存高效**：智能指针管理资源，避免内存泄漏
- **性能优化**：C++17标准，充分利用现代C++特性
- **自适应算法**：根据访问模式动态选择最优缓存策略
- **改进的LFU-Aging**：更精细的频率衰减机制

## 贡献

欢迎提交Issue和Pull Request来改进这个项目。

## 许可证

本项目遵循MIT许可证。

## 致谢

感谢[KamaCache](https://github.com/youngyangyang04/KamaCache)项目提供的灵感和参考。
